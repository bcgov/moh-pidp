name: Remove Helm deployment on PR merge
on:
  pull_request:
    types: [closed]
    branches-ignore:
      - 'test'
      - 'master'
jobs:
  remove-deployment:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Login to Openshift

      uses: redhat-actions/oc-login@v1
      env:
        # These can be stored in secrets, if desired.
        OPENSHIFT_USER: serviceaccount
        OPENSHIFT_NAMESPACE: d8a8f9-dev

      with:
        # URL to your OpenShift cluster.
        # Refer to Step 2.
        openshift_server_url: ${{ secrets.OPENSHIFT_CLUSTER_URL}}

        # Credentials, if desired instead of token.
        # Username and password override token if they are set.
        openshift_token: ${{ secrets.OPENSHIFT_TOKEN}}

        # Disables SSL cert checking. Use this if you don't have the certificate authority data.
        insecure_skip_tls_verify: true

        # Optional - this sets your Kubernetes context's current namespace after logging in.
        namespace: ${{ env.OPENSHIFT_NAMESPACE }}

    # - name: Remove Helm deployment
    #   run: |
    #     helm uninstall pr-${{ env.PR_NUMBER }}
    #   env:
    #     PR_NUMBER: ${{ github.event.issue.number }}
    - name: Remove Helm deployment
      # Find the PR associated with this push, if there is one.
      uses: jwalton/gh-find-current-pr@v1
      id: findPr
      with:
        # Can be "open", "closed", or "all".  Defaults to "open".
        state: closed
    
    - run: helm uninstall pr-${{ env.PR }}
      if: success() && steps.findPr.outputs.number
      env:
        PR: ${{ steps.findPr.outputs.pr }}


  merge_job:
      # this job will only run if the PR has been merged
      if: github.event.pull_request.merged == true
      runs-on: ubuntu-latest
      steps:
      - run: |
          echo PR #${{ github.event.number }} has been merged

  close_job:
    # this job will only run if the PR has been closed without being merged
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    steps:
    - run: |
        echo PR #${{ github.event.number }} has been closed without being merged