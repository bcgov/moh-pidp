{{ $release := .Release.Name }}
{{ $domain := .Values.global.vanityURL }}
{{ $isProd := contains "prod" $ocEnv }}
{{ $ocEnv := regexFind "([^-]*$)" .Release.Namespace }}
{{ $isPR := hasPrefix "pr-" .Release.Name }}

apiVersion: template.openshift.io/v1
kind: Template
metadata:
  annotations:
    description: Template for job that activates pod to send endorsement reminder emails
    tags: cronjob
  name: scheduler-pod-launcher
objects:
  - apiVersion: batch/v1
    kind: CronJob
    metadata:
      name: '${CRON_NAME}'
    spec:
      concurrencyPolicy: Forbid
      suspend: false
      schedule: '${CRON_SCHEDULE}' 
      # Cleaning Up After a Cron Job
      successfulJobsHistoryLimit: 3 
      failedJobsHistoryLimit: 1    
      jobTemplate:
        spec:
          template:
            spec:
              containers:
                - command:
                  - bash
                  - '-c'
                  - >-
                    echo -e "-------- RUNNING CRON --------\n"
                env:
                  - name: DB_HOST
                    valueFrom:
                      configMapKeyRef:
                        name: database-cm
                        key: database-host
                  - name: POSTGRESQL_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: {{ ternary $ocEnv $release $isPR }}-patroni-secret
                        key: app-db-password
                  - name: POSTGRESQL_USER
                    valueFrom:
                      secretKeyRef:
                        name: {{ ternary $ocEnv $release $isPR }}-patroni-secret
                        key: app-db-username
                  - name: POSTGRESQL_DATABASE
                    {{- if $isPR }}
                    value: pidp_{{ $drn }}
                    {{ else }}
                    valueFrom:
                      secretKeyRef:
                        name: {{ ternary $ocEnv $release $isPR }}-patroni-secret
                        key: app-db-name
                    {{- end }}
                  - name: ConnectionStrings__PidpDatabase
                    value: "Host=$(DB_HOST);Port=5432;Database=$(POSTGRESQL_DATABASE);Username=$(POSTGRESQL_USER);Password=$(POSTGRESQL_PASSWORD)"
                  - name: ChesClient__TokenUrl
                    valueFrom:
                      secretKeyRef:
                        name: ches
                        key: ChesClient__TokenUrl
                  - name: ChesClient__ClientId
                    valueFrom:
                      secretKeyRef:
                        name: ches
                        key: ChesClient__ClientId
                  - name: ChesClient__ClientSecret
                    valueFrom:
                      secretKeyRef:
                        name: ches
                        key: ChesClient__ClientSecret
                  - name: ChesClient__Url
                    valueFrom:
                      secretKeyRef:
                        name: ches
                        key: ChesClient__Url
                  - name: ChesClient__Enabled
                    valueFrom:
                      secretKeyRef:
                        name: ches
                        key: ChesClient__Enabled
                  - name: ASPNETCORE_ENVIRONMENT
                    value: {{ .Values.aspnetcore.environment }}
                  - name: ApplicationUrl
                    value: "https://{{ if $isProd }}{{else}}{{ $release }}.{{end}}{{ $domain }}"
                  - name: MailServer__EnableSsl
                    valueFrom:
                      configMapKeyRef:
                        name: mail-settings
                        key: MailServer__EnableSsl
                  - name: MailServer__Url
                    valueFrom:
                      configMapKeyRef:
                        name: mail-settings
                        key: MailServer__Url
                  - name: MailServer__Port
                    valueFrom:
                      configMapKeyRef:
                        name: mail-settings
                        key: MailServer__Port

                - image: >-
                    image-registry.apps.silver.devops.gov.bc.ca/d8a8f9-tools/endorsement-reminder:latest
                  limits:
                    cpu: 500m
                    memory: 2Gi
                  name: '${CRON_NAME}'
                  requests:
                    cpu: 100m
                    memory: 512Mi
                  resources: null
              restartPolicy: Never
parameters:
  - description: 'Cron-like schedule expression. TEST SCHEDULE EVERY TWO MINUTES'
    name: CRON_SCHEDULE
    value: '*/2 * * * *'
  - name: CRON_NAME
    value: scheduler-pod-launcher
  - description: 'Environment name'
    name: ENV_NAME
    required: true
